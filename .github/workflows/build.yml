name: Build my gitbook and deploy to gh-pages

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    name: Build and deploy
    runs-on: ubuntu-latest
    env:
      MY_SECRET   : ${{secrets.GH_ACCESS_TOKEN}}
      USER_NAME   : Alex
      USER_EMAIL  : aliceric27@gmail.com
      BOOK_DIR    : book_sources

    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v2.3.1
      
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '10.21.0'
        
    - name: Install GitBook CLI
      run: |
        npm install -g gitbook-cli
        # ä¿®å¾©æŸäº› npm å‘½ä»¤å•é¡Œ
        npm config set legacy-peer-deps true
        
    - name: Create missing README.md files
      run: |
        cd $BOOK_DIR
        # éæ­·æ‰€æœ‰ç›®éŒ„ï¼Œç¢ºä¿æœ‰ README.md æ–‡ä»¶
        find . -type d -not -path "*/\.*" | while read -r dir; do
          if [ "$dir" != "." ] && [ ! -f "$dir/README.md" ]; then
            dirname=$(basename "$dir")
            echo "# $dirname" > "$dir/README.md"
            echo "å‰µå»ºäº†ç¼ºå¤±çš„ README.md: $dir/README.md"
          fi
        done
        
    - name: Generate SUMMARY.md
      run: |
        cd $BOOK_DIR
        # è‡ªå‹•ç”Ÿæˆ SUMMARY.md
        echo "# ç›®éŒ„" > SUMMARY.md
        echo "" >> SUMMARY.md
        
        # æ·»åŠ ä¸€ç´šç›®éŒ„
        for dir in */; do
          if [ -d "$dir" ] && [ "$dir" != "images/" ]; then
            dirname=${dir%/}
            echo "* [$dirname]($dirname/README.md)" >> SUMMARY.md
            
            # æ·»åŠ äºŒç´šç›®éŒ„
            if [ -d "$dirname" ]; then
              for subdir in "$dirname"/*/; do
                if [ -d "$subdir" ]; then
                  subdirname=$(basename "${subdir%/}")
                  echo "  * [$subdirname]($dirname/$subdirname/README.md)" >> SUMMARY.md
                  
                  # æ·»åŠ ä¸‰ç´šç›®éŒ„
                  if [ -d "$subdir" ]; then
                    for subsubdir in "$subdir"/*/; do
                      if [ -d "$subsubdir" ]; then
                        subsubdirname=$(basename "${subsubdir%/}")
                        echo "    * [$subsubdirname]($dirname/$subdirname/$subsubdirname/README.md)" >> SUMMARY.md
                      fi
                    done
                  fi
                fi
              done
            fi
          fi
        done
        
        # æ·»åŠ å–®ç¨çš„ md æ–‡ä»¶
        for file in *.md; do
          if [ "$file" != "SUMMARY.md" ] && [ "$file" != "README.md" ]; then
            title=$(head -n 1 "$file" | sed 's/^# //')
            echo "* [$title]($file)" >> SUMMARY.md
          fi
        done
        
        cat SUMMARY.md
        
    - name: Build GitBook manually
      run: |
        cd $BOOK_DIR
        # åˆå§‹åŒ– GitBook
        gitbook init
        
        # æ‰‹å‹•å®‰è£æ¯å€‹æ’ä»¶
        gitbook install
        
        # å¦‚æœæ’ä»¶å®‰è£å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥ä½¿ç”¨ npm å®‰è£
        mkdir -p node_modules
        npm install gitbook-plugin-anchor-navigation-ex@1.0.12 --no-save || true
        npm install gitbook-plugin-edit-link --no-save || true
        npm install gitbook-plugin-copy-code-button --no-save || true
        npm install gitbook-plugin-theme-comscore --no-save || true
        npm install gitbook-plugin-ga --no-save || true
        npm install gitbook-plugin-summary --no-save || true
        
        # æ§‹å»º GitBook
        gitbook build
        
        # æª¢æŸ¥æ§‹å»ºçµæœ
        if [ -d "_book" ]; then
          echo "GitBook æ§‹å»ºæˆåŠŸ!"
          ls -la _book/
        else
          echo "GitBook æ§‹å»ºå¤±æ•—!"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      run: |
        cd $BOOK_DIR/_book
        git init
        git config user.name "$USER_NAME"
        git config user.email "$USER_EMAIL"
        git add .
        git commit -m "Deploy to GitHub Pages"
        git remote add origin https://$USER_NAME:$MY_SECRET@github.com/$GITHUB_REPOSITORY.git
        git push -f origin master:gh-pages